---
title: "ACh network effect analysis"
output: html_notebook
---
```{r}
knitr::opts_chunk$set(include=TRUE, collapse=TRUE, warning=FALSE, echo=FALSE)

library(dplyr)
library(plyr)
library(readr)
library(stringr)
library(DT)

library(ggplot2)
library(cowplot)
gtheme = theme_minimal() + theme_cowplot() + 
  theme(text = element_text(size=18), axis.text = element_text(size=15))
library(viridis)
```

```{r}
source('data_import.R')
rootdata_dir = '/mnt/DATA/Audrey/ca_img_result/data/'
gen_imgs_dir = '/tmp/'

dat_files = list.files(rootdata_dir, pattern='dat.*.csv', full.names=TRUE)
all.data = data.frame()
for (traces_file in dat_files) {
  print(paste('reading file:', traces_file))
  data = import.trace(traces_file)
  all.data = rbind(all.data, data)
}
```


```{r}
library(plyr)
frame.rate.hz = 3
cell.event.summary = all.data %>%
  group_by(animal, date, cell_id, exp) %>%
  dplyr::summarise(dur.sec = max(frame) / frame.rate.hz,
            m.event = sum(event / dur.sec)) 

min.cell.fr = 0.003

cell.event.summary = cell.event.summary %>%
  ddply(.(animal, cell_id), summarise,
      isactive=max(m.event) > min.cell.fr) %>% 
  right_join(cell.event.summary, by=c('animal', 'cell_id'))
  

cells.active.df = filter(cell.event.summary, m.event > min.cell.fr) %>%
  select(-dur.sec) %>%
  mutate(animal_cell = paste(animal, cell_id, sep='_'))

recording.summary = cell.event.summary %>%
  group_by(animal, exp) %>%
  dplyr::summarise(ncells=n(),nactive=sum(m.event>min.cell.fr))
```


```{r}
cell.event.summary %>%
  filter(exp=='ACh') %>%
  ggplot() +
  geom_density(aes(x=m.event, colour=animal)) +
  xlim(c(-0.002,0.018))
```

Number of recorded active cells
```{r}
g.slices = recording.summary %>%
  filter(exp == 'Ctrl') %>%
  ggplot() +
  geom_histogram(aes(x=ncells), binwidth=25, fill='white', colour='black') +
  xlab('# Active Cells') +
  ylab('Slices count') +
  gtheme

g.slices
```

```{r}
X = recording.summary %>% filter(exp=='Ctrl') %>%
  mutate(pct_active = round(nactive/ncells * 100))
DT::datatable(X)
```
Pct of cells active at any condition
```{r}
cell.event.summary %>% 
  group_by(animal) %>% 
  dplyr::summarise(n=n()/3, 
                   pct_active=round(sum(isactive)/3/n * 100) ) %>% 
  arrange(desc(pct_active)) %>%
  DT::datatable()
```


```{r}
selected.animals = c('Necab_M13', 'Necab_M11', 'Necab_M8', 'Necab_M3', 'Necab_M4')
```

Number of cells in the selected slices
```{r}
ncells.df = all.data %>%
  filter(animal %in% selected.animals) %>%
  filter(exp=='Ctrl') %>%
  group_by(animal, date) %>%
  dplyr::summarise(ncells=unique(cell_id) %>% length)

mean(ncells.df$ncells)
sd(ncells.df$ncells)
```


Change of # active neurons depending on condition
```{r}
all.data %>%
  filter(animal %in% selected.animals) %>%
  group_by(animal, date, cell_id, exp) %>%
  dplyr::summarise(dur.sec = max(frame) / frame.rate.hz,
                   nevents = sum(event),
            m.event = sum(event / dur.sec)) %>%
  mutate(isactive = nevents > 0,
         animal_cell =paste(animal, cell_id, sep='_')) %>% #filter(animal=='Necab_M11', exp=='ACh') %>% View
  filter(animal_cell %in% cells.active.df$animal_cell) %>% 
  group_by(animal, exp) %>%
  dplyr::summarise(ncells=n(), nactive=sum(isactive), 'Active %'=round(nactive/ncells*100))
```


Number of active cells with events depending on condition
```{r}
recording.summary %>%
  filter(animal %in% selected.animals) %>%
  ggplot(aes(x=exp, y=nactive)) +
  geom_point(aes(colour=exp), size=3) +
  geom_line(aes(group=animal), size=0.2) +
  xlab('') + ylab('# Active cells') + gtheme
```


```{r}
ecdf.summary <- filter(cell.event.summary, animal %in% selected.animals, isactive==TRUE) %>%
  ddply(.(exp), summarize,
                      x=unique(m.event),
                      y=ecdf(m.event)(x))
ggplot(ecdf.summary, aes(x, y=y, colour=exp)) + 
  geom_step() +
  xlab('Event rate (Hz)') +
  ylab('CDF') +
  gtheme
```



```{r}
zscore = function(x) {
  x = (x - mean(x)) / sd(x)
  return(x)
}

selected.timestamps.df = data.frame(
  animal=rep(c('Necab_M3', 'Necab_M4', 'Necab_M8', 'Necab_M11', 'Necab_M13'), each=3),
  exp=rep(c('Ctrl', 'ACh', 'Atr'), 5),
  fst_timestamp=c(50, 400, 50, 
                  50, 750, 400,
                  50, 50, 900,
                  50, 50, 60,
                  50, 50, 1200)
)
rownames(selected.timestamps.df) = paste(selected.timestamps.df$animal, selected.timestamps.df$exp, sep='_')

all.data = ddply(all.data, 
                 .(date, animal, exp, cell_id), 
                 mutate, 
                 ztrace = zscore(strace))
#filtered.all.data = filter(all.data, animal %in% selected.animals) %>%
#  mutate(frame = frame - 1000 * frame.rate.hz) %>%
#  filter(frame <= frame.rate.hz * 400, frame >= 0)

filtered.all.data = filter(all.data, animal %in% selected.animals) %>%
  mutate(frame = frame - selected.timestamps.df[paste(animal,exp, sep='_'),]$fst_timestamp * frame.rate.hz) %>%
  filter(frame >= 0, frame < 420 * frame.rate.hz)
    #filter(paste(animal_id, cell_id, sep='_') %in% cells.active.df$animal_cell)
```

```{r}
animal_file = 'Necab_M13'
data = filter(all.data, animal == animal_file) 
```

```{r}
cells = levels(data$cell_id)
animal.cells.active.df = filter(cells.active.df, animal == animal_file)
animal.cells.active = unique(animal.cells.active.df$cell_id)
selected.cell = as.character(animal.cells.active[2]) %>% as.integer
data = filter(data, cell_id %in% animal.cells.active)

cell.events = filter(data, event > 0, cell_id == selected.cell)
g.trace = data %>%
  filter(cell_id == selected.cell) %>%
  ggplot() +
  geom_line(aes(x=frame / frame.rate.hz, y=trace)) +
  geom_point(data=cell.events, aes(x=frame / frame.rate.hz, y=trace + 1), shape=8, colour='red') +
  xlim(c(0,500)) +
  facet_grid(exp ~ .) +
  xlab('Time (sec)')
g.trace
```

Make activity raster
```{r}
source('clusters.R')
source('correlations.R')

make.activity.raster = function(data, bin.width=1/frame.rate.hz) {
  cor.data = get.cor(data, cond='ACh')
  res.kmeans = eclust(cor.data, FUNcluster = "kmeans", hc_metric = "pearson", k=2, graph=FALSE)
  clust.data = add.cluster2(data, res.kmeans)
  g.activity.raster = plot.activity.raster(clust.data, bin.width) +
      xlim(c(0,400)) 
  g.activity.raster
}

assign.clusters = function(data) {
  res.kmeans.all = list()
  for (cond in levels(data$exp)) {
    exp.data = filter(data, exp==cond)
    cor.data = get.cor(exp.data)
    res.kmeans = eclust(cor.data, FUNcluster = "kmeans", hc_metric = "pearson", k=2, graph=FALSE)
    res.kmeans.all[[cond]] = res.kmeans
  }
  res.kmeans.all
}
g.activity.raster = make.activity.raster(data) 
g.activity.raster
```

Draw dissimilarity matrix
```{r}
source('clusters.R')
plot.cor.dist = function(data, cond, res.kmeans.all) {
  exp.data = filter(data, exp==cond)
  res.kmeans = res.kmeans.all[[cond]]
  
  exp.data = add.cluster2(exp.data, res.kmeans)
  cor.data = get.cor(exp.data)
  sim.dist = as.dist(cor.data)
  #silhouette.ordered = silhouette(res.kmeans$cluster, dissim.dist) %>% sortSilhouette()
  #sim.dist.ordered = as.matrix(sim.dist)[attr(silhouette.ordered, 'iOrd'), attr(silhouette.ordered, 'iOrd')]
  sim.dist.ordered=as.matrix(sim.dist) 
  
  fviz_dist(as.dist(sim.dist.ordered), 
            lab_size = 8, 
            order = FALSE) + 
    scale_fill_viridis(limits=c(-0.5, 1.0), breaks=c(0.0, 1.0), minor_breaks=c(-0.5,0.0,0.5,1.0)) +
    gtheme +
    theme(legend.position = 'top',
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank()) +
    xlab('') + ylab('') +
    labs(fill='Correlation')
}


res.kmeans.all = assign.clusters(data)
plot.cor.dist(data, 'ACh', res.kmeans.all)
```

Add cluster information
```{r}
g.dist.all = plot_grid(
  plot.cor.dist(data, 'Ctrl', res.kmeans.all),
  plot.cor.dist(data, 'ACh', res.kmeans.all),
  plot.cor.dist(data, 'Atr', res.kmeans.all),
  ncol=3)

g.activity = plot_grid(g.activity.raster, g.dist.all, ncol=1)
  
add.cluster.to.all = function(data) {
  animal.data = data.frame()
  for (cond in levels(data$exp)) {
    exp.data = filter(data, exp==cond)
    res.kmeans = res.kmeans.all[[cond]]
    exp.data = add.cluster2(exp.data, res.kmeans)
    if (nrow(animal.data) == 0) {
      animal.data = exp.data
    } else {
      animal.data = bind_rows(animal.data, exp.data)
    }
  }
  animal.data
}

animal.data = add.cluster.to.all(data)

```


Average Silwidths between conditions
```{r}
library(tibble)

get.clus.summary = function(res.kmeans.all) {
  avg.silwidths = rep(0,3)
  clus.size = rep(0,3)
  for (i in 1:3) {
    silinfo = res.kmeans.all[[i]]$silinfo
    avg.silwidths[i] = max(silinfo$clus.avg.widths)
    max.cluster.index = which.max(silinfo$clus.avg.widths)
    clus.size[i] = res.kmeans.all[[i]]$size[max.cluster.index]
  }
  
  data.frame(avg.silwidths=avg.silwidths, 
             clus.size=clus.size,
             exp=names(res.kmeans.all))
}

get.silwidth.df = function(res.kmeans.all) {
  silwidths = data.frame()
  exp.names = names(res.kmeans.all)
  for (i in 1:3) {
    silinfo = res.kmeans.all[[i]]$silinfo
    max.cluster.index = which.max(silinfo$clus.avg.widths)
    swidths = silinfo$widths %>%
      rownames_to_column('cell_id') %>%
      mutate(my.clust = if_else(cluster==max.cluster.index, 1, 2)) %>%
      arrange(my.clust, desc(sil_width)) %>%
      mutate(row.id = row_number(my.clust)) 
    swidths$exp = rep(exp.names[i], nrow(swidths))
    silwidths = bind_rows(silwidths, swidths)
  }
  silwidths$exp = factor(silwidths$exp, levels=exp.names)
  return(silwidths)
}

clus.summary = get.clus.summary(res.kmeans.all)
silwidths = get.silwidth.df(res.kmeans.all)
silwidths$animal = rep(animal_file, nrow(silwidths))
```

```{r}
plot.cluster.assignments = function(silwidths) {
  
 clust.distance = nrow(silwidths)/2
  
 my.clust.df = select(silwidths, animal, cell_id, exp, my.clust) %>%
    spread(exp, my.clust)
 if (! (all(levels(silwidths$exp) %in% colnames(my.clust.df)))) {
   return(ggplot())
 }
 
 my.clust.df = arrange(my.clust.df, Ctrl, ACh, Atr) 
 my.clust.df$ordinal = 1:nrow(my.clust.df)
 
 ordinal.df = group_by(my.clust.df, Ctrl) %>%
   mutate(Ctrl.ordinal=row_number(Ctrl))  %>% 
   ungroup() %>%
   group_by(Atr) %>%
   mutate(Atr.ordinal=row_number(Atr))  %>% 
   ungroup() %>%
   group_by(ACh) %>%
   mutate(ACh.ordinal=row_number(ACh))  %>% 
   ungroup() %>%
   select(animal, cell_id, ends_with('ordinal')) %>%
   gather('Ctrl.ordinal', 'ACh.ordinal', 'Atr.ordinal', key='exp', value='ordinal') 
 
  ordinal.df$exp = str_replace(ordinal.df$exp,'.ordinal','')
  ordinal.df$exp = factor(ordinal.df$exp, levels = levels(silwidths$exp))
  s = left_join(silwidths, ordinal.df, by=c('animal','cell_id', 'exp')) %>%
    mutate(animal_cell = paste(animal, cell_id, sep='_'))
  
  s %>%
    group_by(exp,cluster) %>%
    mutate(row_ordinal = (my.clust - 1) * clust.distance + ordinal) %>%
    ggplot() +
    geom_point(aes(x=exp,y=row_ordinal), size=2) +
    geom_line(aes(x=exp,y=row_ordinal, group=animal_cell), alpha=0.2, size=1) +
    gtheme +
    scale_y_continuous(trans = "reverse") +
    xlab('') + ylab('') +
    #geom_hline(yintercept = 1.3*clust.distance, linetype='dashed', colour='blue', size=1) +
    theme(axis.ticks.y = element_blank(), 
          axis.text.y = element_blank(), 
          axis.line = element_blank(),
          axis.ticks.x = element_blank(),
          legend.position = 'none')
}

plot.cluster.assignments(silwidths)

```




Total activity
```{r}
g.cluster.trace = plot.cluster.traces(animal.data)
g.cluster.trace +
  xlim(c(0,300))
```




Autocorrelogram
```{r}
acf.sec = 40
get.acf = function(x) {
  acf.res = acf(x, lag.max=(frame.rate.hz * acf.sec), plot=FALSE)
  return(c(acf.res$acf))
}


get.cluster.autocorr.df = function(animal.data) {
  mtrace.df = group_by(animal.data, exp, cluster, frame ) %>%
    dplyr::summarise(m.ztrace=mean(ztrace)) %>%
    arrange(frame)
    acf.group = ddply(mtrace.df, .(exp, cluster), summarize,
                    acf.coeff = get.acf(m.ztrace),
                    lag=seq(0, acf.sec * frame.rate.hz)/frame.rate.hz) %>%
    mutate(exp_cluster = paste(exp, cluster, sep='_'))
  
  acf.group
}

plot.autocorr = function(acf.group) {
  acf.group %>%
    ggplot() + 
    geom_line(aes(x = lag, y = acf.coeff, group=exp_cluster, colour=cluster)) +
    geom_hline(yintercept=0, linetype='dashed') +
    facet_grid(. ~ exp) +
    gtheme +
    xlab('Lag (sec)') +
    ylab('Autocorrelation') +
    theme(legend.position='top')
}

g.autocorr = get.cluster.autocorr.df(animal.data) %>% plot.autocorr()
g.autocorr

```

Bin data
```{r}
library(pracma)
bin.dur.sec = 1
all.data.binned.tmp = filtered.all.data %>%
  mutate(bin = ceil(frame / (bin.dur.sec * frame.rate.hz))) 
all.data.binned.tmp$bin = as.factor(all.data.binned.tmp$bin)
all.data.binned = all.data.binned.tmp %>%
   ddply(.(date, animal, exp, bin, cell_id), summarize, 
         df.auc = trapz(frame, ztrace) / length(frame),
         sevent.rate = sum(sevent) / bin.dur.sec,
         event.rate = sum(event) / bin.dur.sec,
         has.event = sum(event) > 0,
         ztrace.max = sort(ztrace, decreasing=TRUE)[2],
         ztrace = mean(ztrace, na.rm = TRUE),
         frame = as.integer(bin[1])*bin.dur.sec * frame.rate.hz)

```

# Identify population events

Calculate population signal - mean traces for animal , experiment
```{r}
animal.data.binned = all.data.binned.tmp %>%
  ddply(.(date, animal, exp, bin), summarize, 
        ztrace.mean = mean(ztrace, na.rm = TRUE),
        frame = min(frame)) 
animal.data.binned$bin = as.integer(animal.data.binned$bin)
animal.data.binned = animal.data.binned %>%
  ddply(.(animal, exp), mutate,
        ztrace.mean.sd = sd(ztrace.mean[1:300/bin.dur.sec]),
        ztrace.min = min(ztrace.mean[1:300/bin.dur.sec])) 
```

Find peaks in population signal
```{r}
get.maxima = function(trace) {
  local.max = c(0, diff(sign(diff(trace)))==-2, 0)
  threshold=0.1
  crossesThreshold = FALSE
  prevLocalMax = NA
  
  res = rep(FALSE, length(local.max))
  for (i in 2:length(local.max)) {
    
    if (trace[i] < threshold) {
      crossesThreshold = TRUE
      prevLocalMax = NA
    }
    
    if (local.max[i]) {
      if (is.na(prevLocalMax)) {
        res[i] = crossesThreshold
        prevLocalMax = i
        crossesThreshold = FALSE
      } else {
        if (!crossesThreshold & trace[i] > trace[prevLocalMax]) {
          res[prevLocalMax] = FALSE
          res[i] = TRUE
          prevLocalMax = i
          crossesThreshold = FALSE
        }
      }
    }
  }
  
  thres.cross = trace > threshold
  peak.durs = rep(0, length(res))
  for (peak in which(res)) {
    left_i = peak - 1
    while (left_i > 1 & thres.cross[left_i]) {
      left_i = left_i - 1
    }
    right_i = peak + 1
    while (right_i < length(thres.cross) & thres.cross[right_i]) {
      right_i = right_i + 1
    }
    peak.durs[peak] = right_i - left_i - 2
  }
  
  return(list(ispeak=res, peak.durs=peak.durs))
}

pop.event.thr = 1.1
animal.data.peaks = animal.data.binned %>%
  arrange(bin) %>%
  ddply(.(animal, exp), mutate,
        local.maximum = get.maxima(ztrace.mean)$ispeak,
        peak.dur = get.maxima(ztrace.mean)$peak.durs) %>%
  mutate(is.pop.event=local.maximum & (ztrace.mean >= pop.event.thr + ztrace.min))  %>%
  filter(is.pop.event)
```

Plot detected population events for single animal
```{r}
plot.pop.events = function(animal_name) {
  filter(animal.data.binned, animal == animal_name) %>%
  ggplot() +
  geom_line(aes(x=bin * bin.dur.sec, y=ztrace.mean)) +
  geom_hline(aes(yintercept=pop.event.thr+ztrace.min), linetype='dashed') +
  geom_point(data=subset(animal.data.peaks, animal==animal_name),
             aes(x=bin*bin.dur.sec, y=ztrace.mean + 0.5), shape=8, colour='red') +
  facet_grid(. ~ exp) +
  xlab('Time (sec)') + ylab('zscored dF/F') +
  gtheme
}

plot.pop.events(animal_file)
```

```{r}
all.data.binned$bin = as.integer(all.data.binned$bin)
pop.events.signal = left_join(all.data.binned, animal.data.peaks, by=c('date', 'animal', 'exp', 'bin')) %>% 
  filter(is.pop.event)

pop.event.ztrace.min = 0.3
pop.events.signal %>%
  group_by(animal, exp, bin) %>% 
  dplyr::summarise(ncells=n(), 
                   nactive=sum(has.event),
                   #nactive2=sum(ztrace.max > (ztrace + 1.0 * ztrace.mean.sd))) ->
                   nactive2=sum(ztrace > pop.event.ztrace.min),
                   event.dur=mean(peak.dur)) ->
  pop.active.df

DT::datatable(pop.active.df)
```

```{r}
pop.active.summary = pop.active.df %>%
  group_by(animal, exp) %>%
  #filter(animal != 'Necab_M4') %>%
  dplyr::summarise(active.m=mean(nactive2) %>% round(),
                   active.pct.m=active.m/ncells[1] * 100 %>% round(0),
                   active.sd=sd(nactive2) %>% round(),
                   active.pct.sd=sd(nactive2/ncells[1]*100) %>% round,
                   nevents=n(),
                   events.freq=round(nevents / (max(bin+1) * bin.dur.sec),3),
                   events.dur=round(mean(event.dur), 1))

DT::datatable(pop.active.summary)

pop.active.summary %>%
  group_by(exp) %>%
  dplyr::summarise('Median participation (%)' = round(median(active.pct.m)),
                   'std (%)'=round(sd(active.pct.m)),
                   'Median freq (Hz)'=round(median(events.freq),3),
                   'std (Hz)'=round(sd(events.freq),2),
                   'Median dur (sec)' = round(median(events.dur, 1)),
                   'std (sec)'=round(sd(events.dur), 1)) ->
  pop.exp.summary
pop.exp.summary
  
ggplot(pop.active.summary, aes(x=exp,y=active.pct.m)) +
  geom_line(aes(group=animal), alpha=0.4) +
  geom_point(size=2,alpha=0.3) +
  gtheme +
  xlab('') + ylab('Neurons participating\n in population events (%)') +
  ylim(c(0,100)) +
ggsave(paste0(gen_imgs_dir, 'pop_events_participation.png'),
       units = 'cm',
       width = 7, height = 9)
```

Clustering based on population events
```{r}

events.participation.thr = 60
events.participation.df = pop.events.signal %>%
  mutate(is.active = ztrace > pop.event.ztrace.min) %>%
  group_by(animal, exp, cell_id) %>%
  dplyr::summarise(total_events=n(),
                   nevents=sum(is.active),
                   events_pct=nevents / total_events * 100) %>%
  mutate(my.clust = ifelse(events_pct >= events.participation.thr, 1, 2),
         cluster = my.clust,
         sil_width = events_pct)

events.participation.df %>%
  group_by(animal, exp) %>%
  dplyr::summarise(n1=sum(my.clust==1),
                   n2=sum(my.clust==2))
```
```{r}
X = events.participation.df %>%
  filter(animal %in% c('Necab_M8', 'Necab_M11', 'Necab_M13'))
plot.cluster.assignments(X) 
ggsave(paste0(gen_imgs_dir,'pop_events_participation_change.png'),
       units = 'cm',
       width = 9, height = 10) 
```



Mean trace change for the same cell
TODO: look at AUC instead
```{r}
library(pracma)

create.cell.summary = function(data, first.sec=500) {
  data %>%
  filter(frame < first.sec * frame.rate.hz) %>%
  group_by(date, animal, exp, cell_id) %>%
  dplyr::summarise(
            m.trace=mean(ztrace), 
            nevents=sum(sevent),
            dur.sec = max(frame) / frame.rate.hz,
            df.auc = trapz(frame, ztrace) / max(frame),
            m.event=nevents/dur.sec) %>%
  dplyr::mutate(mouse_cell=paste(animal, cell_id, sep='_'))
}

data.summary = create.cell.summary(filtered.all.data)
```


```{r}
ecdf.summary <- ddply(data.summary, .(exp), summarize,
                      x=unique(m.event),
                      y=ecdf(m.event)(x))
g.event.cdf = ggplot(ecdf.summary, aes(x, y=y, colour=exp)) + 
  geom_step() +
  xlab('Event rate (Hz)') +
  ylab('CDF') +
  gtheme
g.event.cdf
```

Calculate AUC for dF
```{r}
data.summary %>%
  ggplot() +
  #geom_density(aes(x=df.auc, y=..density.., group=animal), bw=0.07, size=0.7, colour='grey') +
  geom_histogram(aes(x=df.auc ), size=1) +
  gtheme +
  facet_grid(. ~ exp) +
  xlab('dF/F AUC')

```

```{r}
diff.exp = function(vals, exps, diff.order) {
  df = data.frame(x=vals, exp=exps)
  base_i = which(exps==diff.order[1])
  ach_i = which(exps==diff.order[2])
  return(vals[base_i] - vals[ach_i])
}

calculate.metric.diff = function(data, diff.order, var.name) {
  data %>%
    filter(exp %in% diff.order) %>%
    rename_(var = 'var.name') %>%
    ddply(.(animal, cell_id), summarize, var.diff=diff.exp(var, exp, diff.order)) 
}

plot.metric.diff = function(data, gauss.width=0.05, show.groups=TRUE) {
  g = ggplot(data) +
    geom_vline(xintercept=0, linetype='dashed', colour='red', size=1) +
    gtheme 
  if (show.groups) {
    g = g + 
      geom_density(aes(x=var.diff, y=..density.., group=animal), bw=gauss.width, size=0.7, colour='grey') +
      geom_density(aes(x=var.diff, y=..density..), size=1) 
  } else {
    g = g + geom_histogram(aes(x=var.diff)) 
  }
  return(g)
}

diff.order = c('Ctrl', 'ACh')
g.diff.ach.auc = calculate.metric.diff(data.summary, diff.order, 'df.auc') %>%
  plot.metric.diff(gauss.width = 0.15) +
  xlab('Ctrl - ACh dF/F AUC')
g.diff.ach.auc
```



```{r}
diff.order = c('ACh', 'Atr')
g.diff.atr.auc = calculate.metric.diff(data.summary, diff.order, 'df.auc') %>%
  plot.metric.diff(gauss.width = 0.19) +
  xlab('ACh - Atr dF/F AUC')
g.diff.atr.auc
```


```{r}
data.summary %>%
  ggplot(aes(x=exp, y=m.event)) +
  geom_point(aes(colour=animal)) +
  geom_line(aes(group=mouse_cell), size=0.2) +
  xlab('') + ylab('Cell event rate (Hz)')
```
Distribution of changes in event rates -- should group by recording
```{r}
diff.order = c('Ctrl', 'ACh')
g.diff.ach.mer = calculate.metric.diff(data.summary, diff.order, 'm.event') %>%
  plot.metric.diff(gauss.width = 0.002) +
  xlab('Event rate difference: Ctrl - ACh (Hz)')
g.diff.ach.mer 
```
```{r}
diff.order = c('ACh', 'Atr')
g.diff.atr.mer = calculate.metric.diff(data.summary, diff.order, 'm.event') %>%
  plot.metric.diff(gauss.width = 0.003) +
  xlab('Event rate difference: ACh - Atr (Hz)')
g.diff.atr.mer 
```

Create summary of clusters for each animal

```{r}
clus.summary.all = data.frame()
clus.autocorr.all = data.frame()
corr.change = list()
for (animal_id in unique(filtered.all.data$animal)) {
  binned.data = filter(all.data.binned, animal == animal_id)
  res.kmeans.all = assign.clusters(binned.data)
  g.dist.all = plot_grid(
    plot.cor.dist(binned.data, 'Ctrl', res.kmeans.all),
    plot.cor.dist(binned.data, 'ACh', res.kmeans.all),
    plot.cor.dist(binned.data, 'Atr', res.kmeans.all),
    ncol=3)

  animal.data = add.cluster.to.all(binned.data)
  
  clus.summary = get.clus.summary(res.kmeans.all)
  clus.summary$animal = rep(animal_id, 3)
  clus.summary.all = bind_rows(clus.summary.all, clus.summary)
  
  silwidths = get.silwidth.df(res.kmeans.all)
  silwidths$animal = rep(animal_file, nrow(silwidths))
  g.cluster.assignments = plot.cluster.assignments(silwidths)
  
  g.shuffled.cors = plot_grid(
    plot.shuffled.cors(animal.data, 'Ctrl') + gtheme,
    plot.shuffled.cors(animal.data, 'ACh') + gtheme,
    plot.shuffled.cors(animal.data, 'Atr') + gtheme,
    ncol=3)
  corr.change[animal_id] = get.corr.change(animal.data)
                     
  
  data = filter(filtered.all.data, animal == animal_id)
  g.activity.raster = make.activity.raster(data)
  
  
  g.pop.events = plot.pop.events(animal_id) +
    theme(strip.background = element_blank(), strip.text = element_blank())
  
  animal.data = add.cluster.to.all(data)
  clus.autocorr.df = get.cluster.autocorr.df(animal.data) 
  clus.autocorr.df$animal = rep(animal_id, nrow(clus.autocorr.df))
  clus.autocorr.all = bind_rows(clus.autocorr.all, clus.autocorr.df)
  g.autocorr = plot.autocorr(clus.autocorr.df) +
    theme(strip.background = element_blank(), strip.text = element_blank())
 
  g.population.assignments = plot.cluster.assignments(filter(events.participation.df, animal == animal_id))
  
  g.footer = plot_grid(g.cluster.assignments, 
                       g.population.assignments,
                       nrow=1, labels=c('', 'G'), label_size = 32)
  
  g = plot_grid(g.activity.raster, 
                g.pop.events,
                g.dist.all,
                g.shuffled.cors,
                g.autocorr, 
                g.footer, 
                labels = c('A','B', 'C', 'D', 'E', 'F'),
                label_size = 32,
                ncol=1, rel_heights = c(4, 2, 3, 2, 2, 2))
  
  
  ggsave(paste0(gen_imgs_dir, '/cluster_img_', animal_id, '.png'), 
         g,
         units='cm',
         width=35,
         height=50)
}  

clus.summary.all$animal = as.factor(clus.summary.all$animal)
clus.autocorr.all$animal = as.factor(clus.autocorr.all$animal)
clus.summary.all$exp = factor(clus.summary.all$exp, levels=levels(filtered.all.data$exp))
clus.autocorr.all$exp = factor(clus.autocorr.all$exp, levels=levels(filtered.all.data$exp))
```

Clus summary
```{r}
g.sil.widths = clus.summary.all %>%
  ggplot(aes(x=exp, y=avg.silwidths)) +
  geom_line(aes(group=animal), alpha=0.6) +
  geom_point(size=3, alpha=0.5) +
  # stat_compare_means(aes(label = paste0('p=', ..p.format..)),
  #                    method='wilcox.test', paired=TRUE, 
  #                    comparisons = list(c(1,2), c(2,3)))  +
  gtheme +
  xlab('') + ylab('Mean silhouette width') +
  theme(legend.position = 'none')

g.sil.widths
```
```{r}
mean(unlist(corr.change))
sd(unlist(corr.change))
```


```{r}
clus.autocorr.summary = clus.autocorr.all %>%
  filter(cluster == 1) %>%
  group_by(exp, lag) %>%
  dplyr::summarize(acf.coeff.m=mean(acf.coeff),
                   acf.coeff.sd=sd(acf.coeff))
  
  
clus.autocorr.all %>%
  #filter(cluster == 1) %>%
  mutate(animal_clus = paste(animal, str(cluster), sep='_')) %>%
  ggplot(aes(x=lag, y=acf.coeff)) +
  geom_line(aes(group=animal_clus), alpha=0.2) +
  geom_line(data=clus.autocorr.summary, aes(x=lag, y=acf.coeff.m), size=1) +
  facet_grid(. ~  exp) +
  gtheme +
  geom_hline(yintercept=0, linetype='dashed', color='red') +
  xlab('Lag (sec)') +
  ylab('Autocorrelation') 
  
g.acorr.summary = ggplot(clus.autocorr.summary) +
  geom_ribbon(data=clus.autocorr.summary, 
              aes(x=lag, ymin=acf.coeff.m - acf.coeff.sd, ymax=acf.coeff.m + acf.coeff.sd), 
              fill = "grey80", color='black', size=0.2) +
  geom_line(data=clus.autocorr.summary, aes(x=lag, y=acf.coeff.m), size=1) +
  facet_grid(. ~  exp) +
  geom_hline(yintercept=0, linetype='dashed', color='red') +
  gtheme +
  xlab('Lag (sec)') +
  ylab('Autocorrelation') 

g.acorr.summary
```
Time to first peak
```{r}
get.fst.peak.index = function(x, y) {
  filter.width = 3
  y.filtered = stats::filter(y, rep(1/filter.width, filter.width), sides=2)
  
  local.maxima = which(diff(sign(diff(y)))==-2)+1
  
  local.maxima.filtered = c()
  fst.negative = which(sign(y+0.01) == -1)[1]
  for (local.maxium.index in local.maxima) {
    window = 2
    if (local.maxium.index - window > 0 &&
        local.maxium.index + window <= length(y) &&
        fst.negative < local.maxium.index &&
        all(y[local.maxium.index + -window:window] > 0.00)) {
      local.maxima.filtered = c(local.maxima.filtered, local.maxium.index)
    }
  }
  
  if (length(local.maxima.filtered) == 0) {
    return(NA)
  }
  index = local.maxima.filtered[1]
  list(index=index, time=x[index], val=y[index])
}


autocorr.peak.df = ddply(clus.autocorr.all, 
      .(animal, exp, cluster), 
      summarize,
      peak.index=get.fst.peak.index(lag, acf.coeff)['index'] %>% unlist,
      peak.time=get.fst.peak.index(lag, acf.coeff)['time'] %>% unlist,
      peak.val=get.fst.peak.index(lag, acf.coeff)['val'] %>% unlist) %>%
  filter(cluster == 2)

summary(subset(autocorr.peak.df, exp=='Ctrl')$peak.val, digits=1)
summary(subset(autocorr.peak.df, exp=='ACh')$peak.val, digits=1)
```

```{r}
library(ggpubr)

# autocorr.peak.df %>%
#   filter(exp %in% c('Ctrl', 'ACh')) %>%
#   ggpubr::ggpaired(x='exp', y='peak.time', id='animal') +
#   stat_compare_means(aes(label = paste0('p=', ..p.format..)),
#                      method='wilcox.test', paired=TRUE, na.rm=TRUE) 

autocorr.peak.df %>%
  filter(exp %in% c('Ctrl', 'ACh')) %>%
  ggplot(aes(x=exp, y=peak.time)) +
  geom_line(aes(group=animal)) +
  geom_point(size=3, alpha=0.6) +
   #stat_compare_means(aes(label = paste0('p=', ..p.format..)),
   #                   method='wilcox.test', paired=TRUE, 
   #                   comparisons = list(c(1,2)))  +
  xlab('') + ylab('Periodicty of activity (sec)') +
  gtheme

#t.test(peak.time ~ exp, X, paired=TRUE)
```

```{r}
plot_grid(g.sil.widths, g.acorr.summary,
          labels=c('A', 'B'), label_size = 32,
          rel_widths = c(2,3))

ggsave(paste0(gen_imgs_dir, '/fig_clus_sum.png'), 
       units='cm',
       width=23,
       height=11)
```

```{r}
g.footer = plot_grid(g.acorr.summary, g.sil.widths,
          labels=c('', 'D'), ncol=2,
          rel_widths=c(2,1), 
          label_size=32)
plot_grid(g.activity.raster,
          g.dist.all,
          g.footer,
          labels=c('A', 'B', 'C'), ncol=1,
          rel_heights=c(1.8,1.5,1.5), 
          label_size=32)

ggsave(paste0(gen_imgs_dir, 'fig.pdf'), 
       units='cm',
       width=25, height=35)
```


```{r}
ggsave(paste0(gen_imgs_dir, '2_cells_hist.png'), g.slices)

#g.cor.heatmap
g1 = plot_grid(g.trace,  g.activity.raster, 
               g.cluster.trace,
               g.autocorr, ncol=1, rel_heights = c(1,2, 1.5, 1))
ggsave(paste0(gen_imgs_dir, '/Fig1.png'), 
       g1,
       units='cm',
       width=30,
       height=40)

g2 = plot_grid(#g.diff.ach.auc, g.diff.atr.auc, 
               g.diff.ach.mer, g.diff.atr.mer, 
               g.event.cdf, ncol=2,
               labels=c('A', 'B', 'C'), label_size = 32)
ggsave(paste0(gen_imgs_dir, '/Fig2.png'), 
       g2,
       units='cm',
       width=30,
       height=25)
```

