---
title: "ACh network effect analysis"
output: html_notebook
---
```{r import_setup}
knitr::opts_chunk$set(include=TRUE, collapse=TRUE, warning=FALSE, echo=FALSE)

library(dplyr)
library(plyr)
library(readr)
library(stringr)
library(DT)
library(pracma)
library(purrr)
library(reshape2)
library(tidyr)
```

Setup ggplot theme for figure plotting
```{r plotting_setup}
library(ggplot2)
library(cowplot)
library(grid)
library(viridis)

px2pt = 1/(ggplot2::.pt*72.27/96)
# Common GGplot theme for the figures
gtheme = theme_minimal() + theme_cowplot() + 
  theme(text = element_text(size=8, family = 'Arial'), 
        panel.background = element_rect(fill = 'white'),
        line = element_line(size = px2pt),
        title = element_text(size=8),
        plot.title = element_text(size=8, hjust=0.5, face='plain'),
        legend.title = element_text(size=8),
        legend.text = element_text(size=8),
        legend.box.margin = margin(2,2,2,2),
        legend.box.spacing = unit(0, 'mm'),
        strip.background = element_blank(),
        strip.text = element_text(size=8),
        strip.switch.pad.wrap = unit(0.1, 'mm'),
        strip.switch.pad.grid = unit(0.1, 'mm'),
        axis.line.x = element_line(size = 0.8 * px2pt, linetype = "solid", colour = "black"),
        axis.line.y = element_line(size = 0.8 * px2pt, linetype = "solid", colour = "black"),
        axis.text.x=element_text(size=8, colour = "black"),
        axis.text.y=element_text(size=8, colour = "black"),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8))
gtheme.label_size = 10

width_1col = 8.5 
width_15col = 11.6
width_2col = 17.6
```

```{r stats_functions}
sem = function(x) sqrt( var(x, na.rm=TRUE) / length(x))
wilcox.test.w = function(a,b) {
  pair.diff = c(a-b)
  pair.diff = pair.diff[pair.diff!=0]
  diff.rank = rank(abs(pair.diff))
  sum(sign(pair.diff) * diff.rank)
}
```

Read the preprocessed calcium imaging data from csv files:
- dat *.csv files with the caimg traces
- event *.csv files for the events detected in the caimg traces
```{r}
source('data_import.R')
rootdata_dir = '/mnt/DATA/Audrey/ca_img_result/event_threshold_5/'
gen_imgs_dir = '/home/prez/Dropbox/phd/ento_ach_paper/caimg_analysis/figures_generated/'

dat_files = list.files(rootdata_dir, pattern='dat.*.csv', full.names=TRUE)
event_files = list.files(rootdata_dir, pattern='events.*.csv', full.names=TRUE)
all.data = data.frame()
events.data = data.frame()
for (i in 1:length(dat_files)) {
  traces_file = dat_files[i]
  print(paste('reading file:', traces_file))
  data = import.trace(traces_file)
  all.data = rbind(all.data, data)
  
   
  print(paste('reading file:', event_files[i]))
  event.df = read_csv(event_files[i])
  events.data = rbind(events.data, event.df)
}

frame.rate.hz = list(Necab_M3 = 2.3,
                     Necab_M4 = 2.3,
                     Necab_M8 = 2.3,
                     Necab_M11 = 2.3,
                     Necab_M13 = 2.3,
                     Yu_Thy1_1 = 1.3, 
                     Yu_Thy1_2 = 1.3,
                     Yu_Thy1_3 = 1.1,
                     Yu_Thy1_4 = 1.3,
                     Yu_Thy1_5 = 1.3,
                     Yu_Thy1_7 = 1.3)
all.data$frame.rate = frame.rate.hz[as.character(all.data$animal)] %>% unname %>% unlist

events.data$cell_id = as.integer(events.data$cell_id)
events.data$animal = as.factor(events.data$animal)
events.data$exp = as.factor(events.data$exp)

events.data$exp = revalue(events.data$exp, c('Ach'='ACh', 'Atropine'='Atr', 'Baseline'='Ctrl'))
```

Find cells which were active during the recordings
```{r}
cell.event.summary = all.data %>%
  group_by(animal, date, cell_id, exp) %>%
  dplyr::summarise(dur.sec = max(frame) / frame.rate[1],
            m.event = sum(event / dur.sec)) 

min.cell.fr = 0.003

cell.event.summary = cell.event.summary %>%
  ddply(.(animal, cell_id), summarise,
      isactive=max(m.event) > min.cell.fr) %>% 
  right_join(cell.event.summary, by=c('animal', 'cell_id'))

cells.active.df = filter(cell.event.summary, m.event > min.cell.fr) %>%
  select(-dur.sec) %>%
  mutate(animal_cell = paste(animal, cell_id, sep='_'))

recording.summary = cell.event.summary %>%
  group_by(animal, exp) %>%
  dplyr::summarise(ncells=n(),nactive=sum(m.event>min.cell.fr))
```

Number of active cells in control condition per slice
```{r}
g.slices = recording.summary %>%
  filter(exp == 'Ctrl') %>%
  ggplot() +
  geom_histogram(aes(x=ncells), fill='white', colour='black',
                 breaks=seq(30,110,10)) +
  xlab('# Active Cells') +
  scale_x_continuous(breaks=seq(30, 120, 20)) +
  ylab('Slices count') +
  gtheme

g.slices
```


Count of active neurons depending on experimental condition
```{r}
all.data %>%
  group_by(animal, date, cell_id, exp) %>%
  dplyr::summarise(dur.sec = max(frame) / frame.rate[1],
                   nevents = sum(event),
            m.event = sum(event / dur.sec)) %>%
  mutate(isactive = nevents > 0,
         animal_cell =paste(animal, cell_id, sep='_')) %>%
  filter(animal_cell %in% cells.active.df$animal_cell) %>% 
  group_by(animal, exp) %>%
  dplyr::summarise(ncells=n(), nactive=sum(isactive), 'Active %'=round(nactive/ncells*100)) %>%
  DT::datatable()
```

Z-score the traces
```{r}
zscore = function(x) {
  x = (x - mean(x)) / sd(x)
  return(x)
}

all.data = ddply(all.data, 
                 .(date, animal, exp, cell_id), 
                 mutate, 
                 ztrace = zscore(strace))
```

Select the duration of 420 s per each recording
```{r}
selected.timestamps.df = data.frame(
  animal=rep(c('Necab_M3', 'Necab_M4', 'Necab_M8', 'Necab_M11', 'Necab_M13', 
              'Yu_Thy1_1', 'Yu_Thy1_2', 'Yu_Thy1_3', 'Yu_Thy1_4', 'Yu_Thy1_5', 'Yu_Thy1_7'), each=3),
  exp=rep(c('Ctrl', 'ACh', 'Atr'), 11),
  fst_timestamp=c(50, 400, 50, 
                  1250, 750, 400,
                  50, 50, 50,
                  50, 50, 60,
                  10, 50, 500,
                  50, 50, 50, 
                  50, 50, 50,
                  50, 50, 50,
                  70, 50, 50,
                  50, 50, 50,
                  50, 50, 50)
)
rownames(selected.timestamps.df) = paste(selected.timestamps.df$animal, selected.timestamps.df$exp, sep='_')

rec.dur.sec = 420
filtered.all.data = all.data %>%
  mutate(frame = frame - selected.timestamps.df[paste(animal, exp, sep='_'),]$fst_timestamp * frame.rate) %>%
  filter(frame >= 0, frame < rec.dur.sec * frame.rate)

filtered.events.data = events.data %>%
  mutate(Peak_sec=Peak_sec - selected.timestamps.df[paste(animal, exp, sep='_'),]$fst_timestamp) %>%
  filter(Peak_sec >= 0, Peak_sec < rec.dur.sec)
```

# Event analysis
```{r}
filtered.events.data = mutate(filtered.events.data, dur = End_sec - Start_sec) %>%
  mutate(exp_cell = paste0(animal, exp, cell_id, sep='_')) %>%
  mutate(animal_exp = paste0(animal, exp, sep='_')) 

event.freq.df = group_by(filtered.events.data, animal, cell_id, exp, exp_cell, animal_exp) %>%
  dplyr::summarise(event_freq = n() / 420 * 60)

filter(event.freq.df) %>%
  ggplot() +
  stat_ecdf(aes(x=event_freq, group=exp, colour=exp)) +
  gtheme +
  xlab(bquote('Event freq ('*~min^-1*')')) +
  ylab('Probability')
```

No difference between Thy1 and Necab animals in Ctrl condition
* Event frequency
```{r}
event.freq.line = filter(event.freq.df, exp=='Ctrl') %>%
  dplyr::mutate(animal_line = ifelse(startsWith(as.character(animal), 'Necab'), 'Necab', 'Thy1'))
event.freq.line$animal_line = as.factor(event.freq.line$animal_line)
event.freq.line %>%
  group_by(animal, animal_line) %>%
  dplyr::summarise(med.freq = median(event_freq)) -> summary.event.freq.df
wilcox.test(med.freq ~ animal_line, summary.event.freq.df)

summary.event.freq.df %>% 
  group_by(animal_line) %>% 
  dplyr::summarise(freq.med=mean(med.freq), freq.sem=sem(med.freq), n=n())
```

Change in event freq (ACh - Ctrl)
```{r}
animal.freqs = event.freq.df %>%
  group_by(animal, exp) %>%
  dplyr::summarise(med.event.freq = median(event_freq))

shapiro.test(subset(animal.freqs, exp=='Ctrl')$med.event.freq)
shapiro.test(subset(animal.freqs, exp=='ACh')$med.event.freq)
t.test(subset(animal.freqs, exp=='Ctrl')$med.event.freq,
       subset(animal.freqs, exp=='ACh')$med.event.freq, paired = TRUE)
```


Event freq changes of cells on the level of network
```{r}
event.freq.diff = filter(event.freq.df, exp=='ACh') %>%
  full_join(filter(event.freq.df, exp=='Ctrl'), by=c('animal', 'cell_id')) 

# exclude animals with fewer than 10 cells with events in Ctrl
exclude.events.animals = c('Necab_M3', 'Necab_M4', 'Yu_Thy1_1', 'Yu_Thy1_5')

event.freq.diff = replace_na(event.freq.diff, list(event_freq.x=0, event_freq.y=0)) %>%
  filter(!(animal %in% exclude.events.animals)) %>%
  mutate(freq.diff=event_freq.x - event_freq.y)

sampled.freq.diff = event.freq.diff %>%
  group_by(animal) %>%
  sample_n(100, replace = TRUE)

g.event.freq = filter(event.freq.diff) %>%
  ggplot() +
  stat_ecdf(data=sampled.freq.diff, aes(x=freq.diff), color='black', size=1) +
  stat_ecdf(aes(x=freq.diff, group=animal), size=0.2) +
  geom_vline(xintercept = 0, linetype='dashed', color='red') + 
  xlim(c(-1.5, 8)) +
  gtheme +
  xlab('Event frequency change\nACh - Ctrl (min^-1)') +
  ylab('Probability')
g.event.freq
```


Duration change ACh / Ctrl
```{r}
event.dur.df = group_by(filtered.events.data, animal, cell_id, exp, exp_cell, animal_exp) %>%
  dplyr::summarise(dur.mean = mean(dur), dur.med = median(dur), nevents = n()) 

event.dur.ratio = filter(event.dur.df, exp=='ACh') %>%
  left_join(filter(event.dur.df, exp=='Ctrl'), by=c('animal', 'cell_id')) 

event.dur.ratio = replace_na(event.dur.ratio, list(dur.mean.x=0, dur.mean.y=0)) %>%
  filter(nevents.y > 1) %>% # When calculation ratios avoid dividing by zero
  filter(!(animal %in% exclude.events.animals)) %>%
  mutate(dur.mean.ratio=dur.mean.x / dur.mean.y)

sampled.dur.ratio = event.dur.ratio %>%
  group_by(animal) %>%
  sample_n(100, replace = TRUE)

g.event.dur = filter(event.dur.ratio) %>%
  ggplot() +
  stat_ecdf(data=sampled.dur.ratio, aes(x=dur.mean.ratio), size=1) +
  stat_ecdf(aes(x=dur.mean.ratio, group=animal), size=0.2) +
  geom_vline(xintercept = 1, linetype='dashed', color='red') + 
  gtheme +
  scale_x_continuous(breaks=c(1, 3, 5, 7), limits=c(0.5, 8.5) ) +
  xlab('Event duration ratio \nACh / Ctrl') +
  ylab('Probability')
  
g.event.dur

g.events = plot_grid(g.event.freq, g.event.dur, ncol=2,
                     labels = c('A', 'B'), label_size = gtheme.label_size)
ggsave(paste0(gen_imgs_dir, 'S3-events.pdf'), 
       device=cairo_pdf,
       width=width_1col, height=4.5, units='cm')
  
```
Median event duration increase
```{r}
event.dur.ratio %>% group_by(animal) %>%
  dplyr::summarise(mdur.mean.x = median(dur.mean.x),
                   mdur.mean.y = median(dur.mean.y)) -> median.dur.ratio
mean(median.dur.ratio$mdur.mean.x)
sem(median.dur.ratio$mdur.mean.x)
mean(median.dur.ratio$mdur.mean.y)
sem(median.dur.ratio$mdur.mean.y)
wilcox.test(median.dur.ratio$mdur.mean.x, median.dur.ratio$mdur.mean.y, paired=TRUE)
```

No difference between Necab and Thy1 animals in mean event duration
```{r}
event.dur.line = event.dur.df %>%
  dplyr::mutate(animal_line = ifelse(startsWith(as.character(animal), 'Necab'), 'Necab', 'Thy1'))
event.dur.line$animal_line = as.factor(event.dur.line$animal_line)
group_by(event.dur.line, animal, animal_line) %>%
  dplyr::summarise(med.event.dur=median(dur.mean)) -> summary.event.dur.line
shapiro.test(subset(summary.event.dur.line, animal_line =='Necab')$med.event.dur)
shapiro.test(subset(summary.event.dur.line, animal_line =='Thy1')$med.event.dur)
wilcox.test(med.event.dur ~ animal_line, summary.event.dur.line)

summary.event.dur.line %>% 
  group_by(animal_line) %>% 
  dplyr::summarise(freq.med=mean(med.event.dur), freq.sem=sem(med.event.dur), n=n())
```


# Activity in examplar network
```{r}
animal_file = 'Necab_M13'
data = filter(filtered.all.data, animal == animal_file) 
```


```{r}
cells = levels(data$cell_id)
animal.cells.active.df = filter(cells.active.df, animal == animal_file)
animal.cells.active = unique(animal.cells.active.df$cell_id)
selected.cell = as.character(animal.cells.active[5]) %>% as.integer

cell.events = filter(data, event > 0, cell_id == selected.cell)
g.trace = data %>%
  filter(cell_id == selected.cell) %>%
  ggplot() +
  geom_line(aes(x=frame / frame.rate, y=trace)) +
  geom_point(data=cell.events, aes(x=frame / frame.rate, y=trace + 1), shape=8, colour='red') +
  xlim(c(0,500)) +
  facet_grid(exp ~ .) +
  xlab('Time (sec)')
g.trace
```


Make activity raster
```{r}
library(factoextra)
source('clusters.R')
source('correlations.R')

make.activity.raster = function(data) {
  bin.width = data$frame.rate[1]
  cor.data = get.cor(data, cond='ACh')
  res.kmeans = eclust(cor.data, FUNcluster = "kmeans", hc_metric = "pearson", k=2, graph=FALSE)
  clust.data = add.cluster2(data, res.kmeans)
  g.activity.raster = plot.activity.raster(clust.data, bin.width) +
      xlim(c(0,400)) +
      theme(strip.background = element_blank(),
            legend.position = 'right',
            legend.text = element_text(size = 8),
            legend.key.height = unit(2, 'mm'),
            legend.box.margin = margin(0,0,0,0),
            legend.box.spacing = unit(0, 'mm')) +
      labs(fill='z-scored\nΔF/F') 
  g.activity.raster
}

assign.clusters = function(data) {
  res.kmeans.all = list()
  for (cond in unique(data$exp)) {
    exp.data = filter(data, exp==cond)
    cor.data = get.cor(exp.data)
    res.kmeans = eclust(cor.data, FUNcluster = "kmeans", hc_metric = "pearson", k=2, graph=FALSE)
    res.kmeans.all[[cond]] = res.kmeans
  }
  res.kmeans.all
}
g.activity.raster = make.activity.raster(data) 
g.activity.raster
```

Assign each cell to one of two clusters
```{r}
g.dist.all = plot_grid(
  get.cor.data(data, 'Ctrl', res.kmeans.all) %>% plot.cor.dist('Ctrl', res.kmeans.all),
  get.cor.data(data, 'ACh', res.kmeans.all) %>% plot.cor.dist('ACh', res.kmeans.all),
  get.cor.data(data, 'Atr', res.kmeans.all) %>% plot.cor.dist('Atr', res.kmeans.all),
  ncol=3)

g.activity = plot_grid(g.activity.raster, g.dist.all, ncol=1)
  
add.cluster.to.all = function(data) {
  animal.data = data.frame()
  for (cond in levels(data$exp)) {
    exp.data = filter(data, exp==cond)
    res.kmeans = res.kmeans.all[[cond]]
    exp.data = add.cluster2(exp.data, res.kmeans)
    if (nrow(animal.data) == 0) {
      animal.data = exp.data
    } else {
      animal.data = bind_rows(animal.data, exp.data)
    }
  }
  animal.data
}

animal.data = add.cluster.to.all(data)

```


Average Silwidths between conditions
```{r}
library(tibble)

get.clus.summary = function(res.kmeans.all) {
  avg.silwidths = rep(0,3)
  clus.size = rep(0,3)
  for (i in 1:3) {
    silinfo = res.kmeans.all[[i]]$silinfo
    avg.silwidths[i] = max(silinfo$clus.avg.widths)
    max.cluster.index = which.max(silinfo$clus.avg.widths)
    clus.size[i] = res.kmeans.all[[i]]$size[max.cluster.index]
  }
  
  data.frame(avg.silwidths=avg.silwidths, 
             clus.size=clus.size,
             exp=names(res.kmeans.all))
}

get.silwidth.df = function(res.kmeans.all) {
  silwidths = data.frame()
  exp.names = names(res.kmeans.all)
  for (i in 1:3) {
    silinfo = res.kmeans.all[[i]]$silinfo
    max.cluster.index = which.max(silinfo$clus.avg.widths)
    swidths = silinfo$widths %>%
      rownames_to_column('cell_id') %>%
      mutate(my.clust = if_else(cluster==max.cluster.index, 1, 2)) %>%
      arrange(my.clust, desc(sil_width)) %>%
      mutate(row.id = row_number(my.clust)) 
    swidths$exp = rep(exp.names[i], nrow(swidths))
    silwidths = bind_rows(silwidths, swidths)
  }
  silwidths$exp = factor(silwidths$exp, levels=exp.names)
  return(silwidths)
}

clus.summary = get.clus.summary(res.kmeans.all)
silwidths = get.silwidth.df(res.kmeans.all)
silwidths$animal = rep(animal_file, nrow(silwidths))
```

```{r}
plot.cluster.assignments = function(clust.df, clust.distance=50) {
  my.clust.df = select(clust.df, cell_id, exp, my.clust) %>%
    spread(exp, my.clust)
  if (! (all(levels(clust.df$exp) %in% colnames(my.clust.df)))) {
    return(ggplot())
  }
  
  ncells = unique(clust.df$cell_id) %>% length
  my.clust.df = arrange(my.clust.df, Ctrl, ACh, Atr) 
  my.clust.df$ordinal = 1:nrow(my.clust.df)
  
  assignment.groups = my.clust.df %>% 
    group_by(Ctrl, ACh, Atr) %>%
    dplyr::summarise(min.ordinal = min(ordinal),
                     max.ordinal = max(ordinal),
                     pct = round((max.ordinal - min.ordinal + 1)/ ncells * 100)) %>%
    mutate(clust_char = paste0(Ctrl, ACh, Atr)) %>%
    mutate(iscorrect = clust_char %in% c('111', '121', '222', '212'))
  
  assignment.groups$group_ordinal = 1:nrow(assignment.groups)
  
  assignment.points = gather(assignment.groups, 'Ctrl', 'ACh', 'Atr',
                             key='exp', value='clust')
  
  assignment.points = assignment.points %>%
    arrange(clust, group_ordinal) %>%
    ddply(.(exp), mutate,
          cum.pct=cumsum(pct))
  
  assignment.points$group_ordinal = as.factor(assignment.points$group_ordinal)
  assignment.points$exp = factor(assignment.points$exp, levels=c('Ctrl', 'ACh', 'Atr'))
  assignments.polypoints = assignment.points %>%
    mutate(cum.pct.start = cum.pct - pct) %>%
    gather(cum.pct, cum.pct.start, key='src', value='y') %>%
    arrange(clust_char, exp, src)
  
  
  ordered.polypoints = bind_rows(
    filter(assignments.polypoints, src=='cum.pct.start') %>% arrange(exp),
    filter(assignments.polypoints, src=='cum.pct') %>% arrange(desc(exp)))
  
  yintercept = max((filter(ordered.polypoints, clust==1))$y) + clust.distance/2
  ordered.polypoints %>%
    ggplot() +
    geom_hline(aes(yintercept = yintercept), linetype='dashed') +
    geom_polygon(aes(x=exp, 
                  y=ifelse(clust==1, y, y + clust.distance), 
                  #y=cum.pct,
                  fill=iscorrect,
                  group=group_ordinal), alpha=0.7) +
    scale_fill_manual(values = c('grey60', 'black')) +
    theme(axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          line = element_line(size = px2pt * 0.5),
          legend.position = 'none') +
    xlab('') + ylab('')

}

plot.cluster.assignments(silwidths)
```


Autocorrelogram
```{r}
acf.sec = 50
get.acf = function(x, fr) {
  acf.res = acf(x, lag.max=(fr * acf.sec), plot=FALSE)
  ci = 0.95
  n = acf.res$n.used
  clim0 = qnorm((1 + ci)/2) 
  r = acf.res$acf
  se = c()
  for (k in 1:length(acf.res$lag)) {
    se[k] = sqrt(1 + sum(2 * r[1:(k-1)]^2)) / sqrt(n)
  }
  clim = se * clim0
  signif = 1 - c(0, pnorm(r[-1] / se[-length(se)]))
  return(list(acf=c(acf.res$acf), lag=c(acf.res$lag) / fr, ci=clim, signif=signif))
}


get.cluster.autocorr.df = function(animal.data) {
  mtrace.df = group_by(animal.data, exp, cluster, frame ) %>%
    dplyr::summarise(m.ztrace=mean(ztrace), frame.rate = frame.rate[1]) %>%
       arrange(frame)
    acf.group = ddply(mtrace.df, .(exp, cluster), plyr::summarise,
                    acf.coeff = get.acf(m.ztrace, frame.rate[1])$acf,
                    lag=get.acf(m.ztrace, frame.rate[1])$lag) %>%
    mutate(exp_cluster = paste(exp, cluster, sep='_'))
  
  acf.group
}

plot.autocorr = function(acf.group) {
  acf.group %>%
    ggplot() + 
    geom_line(aes(x = lag, y = acf.coeff, group=exp_cluster, colour=cluster)) +
    geom_hline(yintercept=0, linetype='dashed') +
    facet_grid(. ~ exp) +
    gtheme +
    xlab('Lag (sec)') +
    ylab('Autocorrelation') +
    theme(legend.position='top')
}

g.autocorr = get.cluster.autocorr.df(animal.data) %>% plot.autocorr()
g.autocorr

```

Bin data
```{r}
bin.dur.sec = 1
all.data.binned.tmp = filtered.all.data %>%
  mutate(bin = ceil(frame / (bin.dur.sec * frame.rate))) 
all.data.binned.tmp$bin = as.factor(all.data.binned.tmp$bin)
all.data.binned = all.data.binned.tmp %>%
   ddply(.(date, animal, exp, bin, cell_id), summarize, 
         df.auc = trapz(frame, ztrace) / length(frame),
         sevent.rate = sum(sevent) / bin.dur.sec,
         event.rate = sum(event) / bin.dur.sec,
         has.event = sum(event) > 0,
         ztrace.max = sort(ztrace, decreasing=TRUE)[2],
         ztrace = mean(ztrace, na.rm = TRUE),
         trace.max = sort(trace, decreasing=TRUE)[2],
         trace.mean = mean(trace, na.rm = TRUE),
         trace.median = median(trace, na.rm = TRUE),
         strace.mean = mean(strace, na.rm = TRUE),
         strace.median = median(strace, na.rm = TRUE),
         frame = floor(as.integer(bin[1]) * bin.dur.sec * frame.rate[1]))

```

# Identify population events

Calculate population signal - mean traces for animal per experiment
```{r}
animal.data.binned = all.data.binned.tmp %>%
  ddply(.(date, animal, exp, bin), summarize, 
        ztrace.mean = mean(ztrace, na.rm = TRUE),
        frame = min(frame)) 
animal.data.binned$bin = as.integer(animal.data.binned$bin)
animal.data.binned = animal.data.binned %>%
  ddply(.(animal, exp), mutate,
        ztrace.mean.sd = sd(ztrace.mean[1:300/bin.dur.sec]),
        ztrace.min = quantile(ztrace.mean[1:300/bin.dur.sec], 0.1)[1]) 
```

Find peaks in population signal
```{r}
source('peaks.R')

default.pop.event.thr = 1
animal.pop.event.thr = list(
  Necab_M3 = list(Ctrl=0.7, ACh=0.7, Atr=0.7),
  Necab_M4 = list(Ctrl=1.5, ACh=1.5, Atr=1.5),
  Necab_M8 = list(Ctrl=0.65, ACh=0.65, Atr=0.55),
  Necab_M11 = list(Ctrl=0.8, ACh=0.8, Atr=0.8),
  Necab_M13 = list(Ctrl=1.0, ACh=1.0, Atr=1.0),
  Yu_Thy1_1 = list(Ctrl=0.7, ACh=0.7, Atr=1.0),
  Yu_Thy1_2 = list(Ctrl=1.0, ACh=1.0, Atr=1.0),
  Yu_Thy1_3 = list(Ctrl=0.75, ACh=0.75, Atr=0.75),
  Yu_Thy1_4 = list(Ctrl=0.8, ACh=0.8, Atr=0.8),
  Yu_Thy1_5 = list(Ctrl=0.8, ACh=0.8, Atr=0.8),
  Yu_Thy1_7 = list(Ctrl=1.0, ACh=1.4, Atr=1.4)
)

get.pop.event.thr = function(animal, exp) {
  res = animal.pop.event.thr[[as.character(animal)]][[as.character(exp)]]
    if (is.null(res)) {
      res = default.pop.event.thr
    }
  return(res)
}

animal.data.binned = animal.data.binned %>%
  mutate(ztrace.shifted=ztrace.mean-ztrace.min)

timebin.isevent = animal.data.binned %>%
  arrange(bin) %>%
  ddply(.(animal, exp), mutate,
        pop.event.thr = get.pop.event.thr(animal[1], exp[1]),
        local.maximum = get.maxima(ztrace.shifted, pop.event.thr[1])$ispeak,
        peak.dur = get.maxima(ztrace.shifted, pop.event.thr[1])$peak.durs * bin.dur.sec,
        peak.start = get.maxima(ztrace.shifted, pop.event.thr[1])$peak.starts * bin.dur.sec, 
        peak.end = get.maxima(ztrace.shifted, pop.event.thr[1])$peak.ends * bin.dur.sec, 
        peak.val = get.maxima(ztrace.shifted, pop.event.thr[1])$peak.vals * bin.dur.sec) %>%
  mutate(exceeds.thresh = peak.val >= pop.event.thr,
         is.pop.event=local.maximum & exceeds.thresh)
  
animal.data.peaks = timebin.isevent %>%
  filter(is.pop.event)
```


Plot detected population events for one animal
```{r}
plot.pop.events = function(animal_name) {
  animal.peaks = subset(animal.data.peaks, animal==animal_name)
  thresholds.df = data.frame(threshold=c(
    get.pop.event.thr(animal_name, 'Ctrl'),
    get.pop.event.thr(animal_name, 'ACh'),
    get.pop.event.thr(animal_name, 'Atr')),
    exp = levels(animal.peaks$exp))
  g = filter(animal.data.binned, animal == animal_name) %>%
    ggplot() +
    geom_line(aes(x=bin * bin.dur.sec, y=ztrace.shifted)) +
    geom_hline(data=thresholds.df, aes(yintercept=threshold), linetype='dashed') +
    facet_grid(. ~ exp) +
    xlab('Time (sec)') + ylab('s.d.') +
    xlim(c(0,400))
  if (nrow(animal.peaks) > 0) {
    g = g +     
      geom_point(data=animal.peaks,
                 aes(x=bin*bin.dur.sec, y=2.5), shape=8, colour='red', size=0.5)
  }
  g + gtheme + theme(line = element_line(size=0.5*px2pt))
}

animal_file = 'Yu_Thy1_7'

plot.pop.events(animal_file)
filter(animal.data.peaks, animal==animal_file, exp=='ACh') 
```
Find cells participating in events
```{r}
all.data.binned$bin = as.integer(all.data.binned$bin)
pop.events.signal = left_join(filter(timebin.isevent, exceeds.thresh),
                              all.data.binned, by=c('date', 'animal', 'exp', 'bin'))

cell.event.participation.df = pop.events.signal %>%
  dplyr::group_by(animal, exp, cell_id, peak.start) %>%
  dplyr::summarise(ztrace.max = max(ztrace),
                   participates = max(ztrace) > pop.event.thr[1],
                   peak.dur=peak.dur[1],
                   pop.ztrace.mean=ztrace.mean[1],
                   pop.trace.mean=trace.mean[1],
                   pop.strace.mean=strace.mean[1]) 
```

Table with metrics on all population events
```{r}
cell.event.participation.df %>%
  dplyr::group_by(animal, exp, peak.start) %>% 
  dplyr::summarise(ncells=n(), 
                   #nactive=sum(has.event),
                   #nactive2=sum(ztrace - ztrace.min > 0.5),
                   nactive=sum(participates),
                   event.dur=mean(peak.dur),
                   pop.zscore.mean=mean(pop.ztrace.mean) %>% round(2),
                   pop.trace.mean=mean(pop.trace.mean) %>% round(2),
                   pop.trace.median=median(pop.trace.mean) %>% round(2),
                   pop.strace.mean=mean(pop.strace.mean) %>% round(2),
                   pop.trace.median=median(pop.trace.mean) %>% round(2)) ->
  pop.active.df

DT::datatable(pop.active.df)
```

Summary on a cell participation in events
```{r}
cell.participation.summary = cell.event.participation.df %>%
  dplyr::group_by(animal, exp, cell_id) %>%
  dplyr::summarise(nbins=n(),
                   ztraces.min = min(ztrace.max),
                   ztraces.max = max(ztrace.max),
                   ztraces.mean = mean(ztrace.max),
                   ztrace.sd = sd(ztrace.max),
                   pct.participate = sum(participates) / nbins * 100)
```

Percent of events that a cell participates
```{r}
events.participation.thr = 70
events.participation.df = cell.event.participation.df %>%
  group_by(animal, exp, cell_id) %>%
  dplyr::summarise(total_events=n(),
                   nevents=sum(participates),
                   events_pct=nevents / total_events * 100) %>%
  mutate(my.clust = ifelse(events_pct >= events.participation.thr, 1, 2),
         cluster = my.clust,
         sil_width = events_pct)
```

Fraction of pop events that a cell participates by experiment
```{r}
ctrl.pop.animals = subset(events.participation.df, exp=='Ctrl' & nevents > 1)$animal %>% unique

sample.by.animal.exp = function(df, nsamples=100) {
  group_by(df, animal, exp) %>%
    sample_n(nsamples, replace = TRUE) %>%
    ungroup()
}

animal.participation.summary = cell.participation.summary %>%
  filter(exp != 'Atr') %>%
  filter(animal %in% ctrl.pop.animals) %>%
  group_by(animal, exp) %>%
  dplyr::summarise(n=n(),
                   pct.median = median(pct.participate),
                   pct75 = quantile(pct.participate, c(0.75))[1],
                   frac60 = (1 - ecdf(pct.participate)(60)) * 100,
                   frac70 = (1 - ecdf(pct.participate)(70)) * 100,
                   frac80 = (1 - ecdf(pct.participate)(80)) * 100)

animal.participation.summary %>%
  group_by(exp) %>%
  dplyr::summarise(mean.frac=mean(frac70),
                   sem.frac=sem(frac70))

shapiro.test(subset(animal.participation.summary, exp=='Ctrl')$frac70)
shapiro.test(subset(animal.participation.summary, exp=='ACh')$frac70)
wilcox.test(subset(animal.participation.summary, exp=='Ctrl')$frac70,
            subset(animal.participation.summary, exp=='ACh')$frac70,
            paired=TRUE)
wilcox.test.w(subset(animal.participation.summary, exp=='Ctrl')$frac70,
              subset(animal.participation.summary, exp=='ACh')$frac70)
cell.participation.summary %>%
  filter(exp != 'Atr') %>%
  filter(animal %in% ctrl.pop.animals) %>%
  ungroup() %>%
  sample.by.animal.exp(nsamples=100) %>%
  group_by(exp) %>%
  dplyr::summarise(n=n(),
                   median(pct.participate),
                   sd(pct.participate))
```

```{r}
g.cell.participation = cell.participation.summary %>%
  filter(exp != 'Atr') %>%
  #filter(exp=='ACh') %>%
  filter(animal %in% ctrl.pop.animals) %>%
  mutate(animal_exp=paste(animal, exp)) %>%
  sample.by.animal.exp(nsamples=100) %>%
  ggplot() +
  stat_ecdf(aes(x=pct.participate, linetype=exp)) +
  #geom_density() +
  #facet_wrap(. ~ animal, scales = 'free_y', ncol = 4) +
  geom_vline(xintercept = 80, linetype='dashed', color='grey50') +
  scale_x_continuous(breaks=c(0, 20, 40, 60, 80, 100)) +
  scale_y_continuous(breaks=c(0, 0.5, 1.0)) +
  scale_linetype_manual(values=c('dashed', 'solid')) +
  gtheme +
  labs(legend='') +
  xlab('Population events active (%)') + ylab('Cells fraction')

g.cell.participation
```

Cell's avg z-score during population events
```{r}
cell.event.participation.df %>%
  group_by(animal,exp,cell_id) %>%
  dplyr::summarise(cell.ztrace.max = max(ztrace.max),
                   cell.ztrace.mean = mean(ztrace.max),
                   cell.ztrace.sd = sd(ztrace.max)) %>% 
  ggplot() +
  geom_density(aes(x=cell.ztrace.sd/cell.ztrace.mean, color=exp, stat(count))) +
  #geom_vline(aes(xintercept=pop.thr, color=exp)) +
  facet_grid(. ~ animal, scales = 'free_x') + 
  coord_flip() +
  xlim(c(-1,2)) +
  xlab('Coefficient of variation during pop event')
  gtheme 
```

Stats and figures on event participation
```{r}
pop.active.summary = pop.active.df %>%
  group_by(animal, exp) %>%
  #filter(animal != 'Necab_M4') %>%
  dplyr::summarise(active.m=mean(nactive) %>% round(),
                   active.pct.m=active.m/ncells[1] * 100 %>% round(0),
                   active.sem=sem(nactive) %>% round(),
                   active.pct.sem=sem(nactive/ncells[1]*100) %>% round,
                   mean.zscore = round(mean(pop.zscore.mean), 1),
                   mean.trace = round(mean(pop.trace.mean), 2), 
                   median.trace = round(median(pop.trace.mean), 2), 
                   median.strace = round(median(pop.strace.mean), 2), 
                   nevents=n(),
                   events.freq=round(nevents / 420 * 60, 1),
                   events.dur=round(median(event.dur), 1))


DT::datatable(pop.active.summary)

pop.active.summary %>%
  group_by(exp) %>%
  dplyr::summarise(events.dur.mean = mean(events.dur),
                   events.dur.sem = sem(events.dur),
                   events.freq.mean = mean(events.freq),
                   events.freq.sem = sem(events.freq))


# Signif tests for duration
shapiro.test(subset(pop.active.summary, exp=='Ctrl')$events.dur)
shapiro.test(subset(pop.active.summary, exp=='ACh')$events.dur)
shapiro.test(subset(pop.active.summary, exp=='Atr')$events.dur)
t.test(events.dur ~ exp, subset(pop.active.summary, exp != 'Atr'), paired=TRUE)
t.test(events.dur ~ exp, subset(pop.active.summary, exp != 'Ctrl'), paired=TRUE)

g.pop.event.dur = pop.active.summary %>%
  #filter(exp != 'Atr') %>%
  ggplot() +
  geom_line(aes(x=exp, y=events.dur, group=animal)) +
  gtheme +
  xlab('') +
  ylab('Duration (s)')

# Signif tests for frequency
shapiro.test(subset(pop.active.summary, exp=='Ctrl')$events.freq)
shapiro.test(subset(pop.active.summary, exp=='ACh')$events.freq)
shapiro.test(subset(pop.active.summary, exp=='Atr')$events.freq)
t.test(events.freq ~ exp, subset(pop.active.summary,exp != 'Atr'), paired=TRUE)
t.test(events.freq ~ exp, subset(pop.active.summary,exp != 'Ctrl'), paired=TRUE)

g.pop.event.freq = pop.active.summary %>%
  #filter(exp != 'Atr') %>%
  ggplot() +
  geom_line(aes(x=exp, y=events.freq, group=animal, color=animal)) +
  gtheme +
  xlab('') +
  ylab('Frequency (min-1)')

# Signif tests for peak value
shapiro.test(subset(pop.active.summary, exp=='Ctrl')$median.strace)
shapiro.test(subset(pop.active.summary, exp=='ACh')$median.strace)
shapiro.test(subset(pop.active.summary, exp=='Atr')$median.strace)
t.test(median.strace ~ exp, subset(pop.active.summary, exp != 'Atr'), paired=TRUE)
wilcox.test(median.strace ~ exp, subset(pop.active.summary, exp != 'Ctrl'), paired=TRUE)
wilcox.test.w(subset(pop.active.summary, exp == 'ACh')$median.strace, subset(pop.active.summary, exp == 'Atr')$median.strace)

g.pop.event.peak = pop.active.summary %>%
  #filter(exp != 'Atr') %>%
  ggplot() +
  geom_line(aes(x=exp, y=median.strace, group=animal)) +
  gtheme +
  xlab('') +
  ylab('Median Peak dF/F (%)')

library(grid)
g.pop.event.stats = plot_grid(
                              g.pop.event.dur,
                              grob(),
                              g.pop.event.freq, 
                              grob(),
                              g.pop.event.peak,
                              ncol=5, 
                              rel_widths = c(2,1.4,2,1.4,2),
                              labels=c('C', '', 'D', '','E'), label_size=gtheme.label_size)
```

# Plots of population event participation 
```{r}
has.pop.event = pop.active.summary %>%
  filter(exp != 'Atr') %>%
  dplyr::group_by(animal) %>%
  dplyr::mutate(nexp=n()) %>%
  filter(nexp==2)
has.pop.event = unique(has.pop.event$animal)

pop.active.df %>%
  filter(animal %in% has.pop.event) %>%
  mutate(animal_exp = paste(animal, exp, sep='_')) %>%
  ggplot(aes(x=nactive/ncells, stat(count), color=exp)) +
  geom_density(alpha=1.0) +
  facet_grid(. ~ animal, scales='free') +
  theme(legend.position = 'top',
        axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() +
  xlim(c(0,1.0)) +
  #gtheme +
  labs(color='') +
  ylab('# Events') +
  xlab('Participating cells fraction')
ggsave(paste0(gen_imgs_dir, 'pop_events_participation_dist.png'),
       units = 'cm',
       width = 25, height = 9)

pop.active.summary %>%
  group_by(exp) %>%
  dplyr::summarise('Median participation (%)' = round(median(active.pct.m)),
                   'std (%)'=round(sd(active.pct.m)),
                   'Median freq (min^-1)'=round(median(events.freq),1),
                   'std (Hz)'=round(sd(events.freq),2),
                   'Median dur (sec)' = round(median(events.dur, 1)),
                   'std (sec)'=round(sd(events.dur), 1)) ->
  pop.exp.summary
pop.exp.summary
  
pop.active.summary %>%
  filter(animal %in% has.pop.event) %>%
  ggplot(aes(x=exp,y=active.pct.m)) +
  geom_line(aes(group=animal, color=animal), alpha=0.4) +
  geom_errorbar(aes(ymin=active.pct.m-active.pct.sem, ymax=active.pct.m+active.pct.sem, color=animal),
                width=.1, alpha=0.6)+
  geom_point(aes(color=animal), size=2, alpha=0.6) +
  gtheme +
  xlab('') + ylab('Neurons participating\n in population events (%)') +
  #theme(legend.position = 'none')+
  ylim(c(50,100)) 
ggsave(paste0(gen_imgs_dir, 'S5-pop_events_participation.png'),
       units = 'cm',
       width = 7, height = 9)
```

Clustering based on population events
```{r}
events.participation.df %>%
  group_by(animal, exp) %>%
  dplyr::summarise(n1=sum(my.clust==1),
                   n2=sum(my.clust==2),
                   total_events=max(total_events))
```

```{r, warnings=FALSE}
source('prob_of_reassignment.R')

reassignment.percentiles = map_dbl(ctrl.pop.animals, ~ {
  animal.df = ungroup(filter(events.participation.df, animal==.x))
  calc.reassigment.percentile(animal.df)$percentile
})
reassignment.percentiles

X = events.participation.df %>%
  filter(animal %in% ctrl.pop.animals)
  #filter(animal == 'Necab_M13')
X = mutate(X, cell_id = (as.numeric(animal) - 1) * 300 + as.numeric(as.character(cell_id)))
g.cluster.assignments.all = plot.cluster.assignments(ungroup(X)) 
g.cluster.assignments.all
ggsave(paste0(gen_imgs_dir,'pop_events_participation_change_thr', num2str(events.participation.thr, fmt=0) ,'.pdf'),
       device=cairo_pdf,
       units = 'cm',
       width = 8, height = 6) 
calc.reassigment.percentile(ungroup(X))$percentile 
```

```{r}
cell.participation.grid = plot_grid(
  g.cell.participation + theme(legend.position = 'top'), 
  g.cluster.assignments.all, 
  nrow=1,
  rel_widths = c(2,3),
  labels = c('D', 'E'))

ggsave(paste0(gen_imgs_dir, '4-cell_participation.pdf'), 
       device=cairo_pdf,
       cell.participation.grid,
       units='cm',
       width=width_1col + 1.5,
       height=5)
```


Change in event rate
```{r}
exp.peak.durs = animal.data.peaks %>%
  group_by(animal, exp) %>%
  dplyr::summarise(upstate.dur.sec = sum(peak.dur)) %>%
  dplyr::mutate(downstate.dur.sec = rec.dur.sec - upstate.dur.sec)

mer.state = left_join(cell.events.df, exp.peak.durs) %>%
  dplyr::mutate(mer.upstate = nduring.event / upstate.dur.sec,
                mer.downstate = (nevents - nduring.event) / downstate.dur.sec)

mer.diff.ach = filter(mer.state, exp=='ACh') %>%
  full_join(filter(mer.state, exp=='Ctrl'), by=c('animal', 'cell_id')) %>%
  dplyr::mutate(mer.upstate.diff = replace_na(mer.upstate.x, 0) - replace_na(mer.upstate.y, 0),
                mer.downstate.diff = replace_na(mer.downstate.x, 0) - replace_na(mer.downstate.y, 0))
```

Plot diff in cell event rates as the result of ACh
```{r}
ggplot(mer.diff.ach) +
  geom_point(aes(x=mer.upstate.diff, y=mer.downstate.diff, color=animal)) +
  geom_vline(xintercept = 0, linetype='dashed') +
  geom_hline(yintercept = 0, linetype='dashed') +
  gtheme +
  xlab('UP-state event rate change') +
  ylab('DOWN-state event rate change')

```


Mean trace change for the same cell
```{r}
library(pracma)

create.cell.summary = function(data, first.sec=500) {
  data %>%
  filter(frame < first.sec * frame.rate) %>%
  group_by(date, animal, exp, cell_id) %>%
  dplyr::summarise(
            m.trace=mean(ztrace), 
            nevents=sum(sevent),
            dur.sec = max(frame) / frame.rate[1],
            df.auc = trapz(frame, ztrace) / max(frame),
            m.event=nevents/dur.sec) %>%
  dplyr::mutate(mouse_cell=paste(animal, cell_id, sep='_'))
}

data.summary = create.cell.summary(filtered.all.data)
```


# Figure 5 - Calcium activity and population events change
Create summary figure for each animal, sub figures:
A) Activity raster
B) Population signal and population events
C) Participation in the events
```{r, warning=FALSE}
source('prob_of_reassignment.R')

upstate.bins = filter(timebin.isevent, exceeds.thresh)
clus.autocorr.all = data.frame()

filter.upstate = function(binned.data, animal.upstates, exp_name) {
  filter(binned.data, 
         exp==exp_name, 
         bin %in% subset(animal.upstates, exp==exp_name)$bin)
}

for (animal_id in unique(filtered.all.data$animal)) {
  # A) Activity raster
  data = filter(filtered.all.data, animal == animal_id)
  g.activity.raster = make.activity.raster(data)
  
  # Calculate autocorrelations for Figure 6
  animal.data = add.cluster.to.all(data)
  clus.autocorr.df = get.cluster.autocorr.df(animal.data) 
  clus.autocorr.df$animal = rep(animal_id, nrow(clus.autocorr.df))
  clus.autocorr.all = bind_rows(clus.autocorr.all, clus.autocorr.df)

  # B) Population events  
  g.pop.events = plot.pop.events(animal_id) +
    theme(strip.background = element_blank(), strip.text = element_blank())
 
  # C) Participation in population events
  animal.events.participation = filter(events.participation.df, animal == animal_id)
  reassignment.precentile = calc.reassigment.percentile(animal.events.participation)$percentile 
  g.population.assignments = plot.cluster.assignments(animal.events.participation) +
    annotate('text', label=paste('p-val=', sprintf('%.2f', reassignment.precentile)),
             x=1, y=50, size=8)
  
  g = plot_grid(g.activity.raster, 
                g.pop.events,
                g.population.assignments, 
                labels = c('A','B', 'C'),
                label_size = gtheme.label_size,
                ncol=1, 
                rel_heights = c(4,2, 2),
                rel_widths = c(2, 2, 1))
  
  ggsave(paste0(gen_imgs_dir, '/cluster_img_', animal_id, '.png'), 
         g,
         units='cm',
         width=width_2col,
         height=25)
}  

clus.autocorr.all$animal = as.factor(clus.autocorr.all$animal)
clus.autocorr.all$exp = factor(clus.autocorr.all$exp, levels=levels(filtered.all.data$exp))
```

```{r}
# Autocorrelation on entire population signal
pop.autocorr.lags = animal.data.binned %>%
  ddply(.(animal, exp), plyr::summarize,
        acf.coeff = get.acf(ztrace.mean, 1/bin.dur.sec)$acf,
        lag = get.acf(ztrace.mean, 1/bin.dur.sec)$lag, 
        ci = get.acf(ztrace.mean, 1/bin.dur.sec)$ci,
        signif = get.acf(ztrace.mean, 1/bin.dur.sec)$signif)

mpop.autocorr.lags = pop.autocorr.lags %>%
  group_by(exp,lag) %>%
  dplyr::summarise(acf.mean = mean(acf.coeff),
                   acf.median = median(acf.coeff),
                   acf.sem = sem(acf.coeff)) 
  
g.acorr.summary = pop.autocorr.lags %>%
  filter(animal == 'Necab_M13') %>%
  ggplot(aes(x=lag)) +
  geom_ribbon(aes(group=animal, ymax=ci, ymin=-ci), fill='grey80' ) +
  geom_line(aes(group=animal, y=acf.coeff)) +
  facet_grid(. ~  exp) +
  gtheme +
  xlim(c(0,50))+
  scale_x_continuous(breaks=c(0,20,40)) +
  geom_hline(yintercept=0, linetype='dashed', color='red') +
  xlab('Lag (sec)') +
  ylab('Autocorrelation') 

g.acorr.summary
```

Time to first peak in the autocorrelogram
```{r}
get.fst.peak.index = function(x, y, signif) {
  filter.width = 3
  y.filtered = stats::filter(y, rep(1/filter.width, filter.width), sides=2)
  
  local.maxima = which(diff(sign(diff(y)))==-2)+1
  
  local.maxima.filtered = c()
  which.negative = which(sign(y+0.01) == -1)
  fst.negative = which.negative[1]
  
  if (length(which.negative) == 0) {
    fst.negative=length(y)
  }
  
  for (local.maxium.index in local.maxima) {
    window = 1/bin.dur.sec
    if (local.maxium.index - window > 0 &
        local.maxium.index + window <= length(y) &
        fst.negative < local.maxium.index &
        all(y[(local.maxium.index - window):(local.maxium.index+window)] > 0.00)) {
      local.maxima.filtered = c(local.maxima.filtered, local.maxium.index)
    }
  }
  
  if (length(local.maxima.filtered) == 0) {
    min.index=fst.negative
    idx = which.max(y[min.index:length(y)]) + min.index - 1
    return(list(index=idx, time=x[idx], val=y[idx], signif=signif[idx]))
  }
  index = local.maxima.filtered[1]
  list(index=index, time=x[index], val=y[index], signif=signif[index])
}

peak.autocorr.lags = ddply(pop.autocorr.lags,
      .(animal, exp),
      plyr::summarise,
      peak.index=get.fst.peak.index(lag, acf.coeff, signif)[['index']] %>% unlist,
      peak.time=get.fst.peak.index(lag, acf.coeff, signif)[['time']] %>% unlist,
      peak.val=get.fst.peak.index(lag, acf.coeff, signif)[['val']] %>% unlist,
      peak.signif=get.fst.peak.index(lag, acf.coeff, signif)[['signif']] %>% unlist) 

g.acorr.signif = peak.autocorr.lags %>%
  group_by(exp) %>%
  dplyr::summarise(pct=sum(peak.signif <= 0.05)/ n() * 100) %>%
  ggplot(aes(x=exp, y=pct)) +
  geom_bar(stat='identity') +
  gtheme +
  ylab('Percent') +
  xlab('') +
  ylim(c(0, 100))

g.acorr.change = peak.autocorr.lags %>%
  filter(peak.signif <= 0.05) %>%
  filter(exp == 'ACh') %>%
  ggplot(aes(x=exp)) +
  geom_jitter(aes(y=peak.time), size=1, fill='white', width=0.2, height=0.1) +
  gtheme +
  xlab('') +
  ylim(c(0,35)) +
  labs(size='Value') +
  ylab('Peak lag (s)') +
  theme(legend.position = 'none')
g.acorr.change
  

peak.autocorr.lags %>%
  filter(peak.signif <= 0.05) %>%
  group_by(exp) %>%
  dplyr::summarise(n=n() - sum(is.na(peak.time)),
                   mean.peak.val = mean(peak.val, na.rm=TRUE),
                   sd.peak.val = sd(peak.val),
                   mean.peak.time = mean(peak.time),
                   sd.peak.time = sd(peak.time))

wilcox.test(peak.time ~ exp, filter(peak.autocorr.lags, exp!='Atr'), paired=TRUE)
wilcox.test(peak.val ~ exp, filter(peak.autocorr.lags, exp!='Atr'), paired=TRUE)
```


Merge and save figures
```{r warning=FALSE}
animal_id = 'Necab_M13'
g.pop.events = plot.pop.events(animal_id) +
  theme(strip.background = element_blank(), strip.text = element_blank())

g.acorr = plot_grid(
  g.acorr.summary, 
  plot_grid(g.acorr.signif, g.acorr.change, ncol=2,
            labels=c('B',  'C'), label_size=gtheme.label_size,
            rel_widths=c(1.5,1)),
  nrow=2,
  labels=c('A', ''), label_size=gtheme.label_size)

ggsave(paste0(gen_imgs_dir, '6-autocorrelation.pdf'), 
       device=cairo_pdf,
       g.acorr,
       units='cm',
       width=width_1col,
       height=8)

g.pop = plot_grid(
  #grob(),
  g.activity.raster, 
  plot_grid(grob(), g.pop.events, rel_widths = c(0.1,3), ncol=2), 
  g.pop.event.stats,
  ncol=1, labels=c('A','B',''), label_size = gtheme.label_size,
  rel_heights = c(3, 1.05, 2))

ggsave(paste0(gen_imgs_dir, '5-population-activity_small.pdf'), 
       g.pop,
       device=cairo_pdf,
       units='cm',
       width=width_2col,
       height=15)

```

# Correlations vs distance
```{r warning=FALSE}
coords.df = read.csv(paste(rootdata_dir, 'coords.csv', sep='/'))
joined.coords = left_join(coords.df, coords.df, 
                          by=c('animal'),
                          suffix=c('.fst', '.snd')) 
dist.df = joined.coords %>%
  mutate(dist = sqrt((x.fst-x.snd)^2 + (y.fst - y.snd)^2)) %>%
  select(animal, cell.fst, cell.snd, dist)


cor.df = data.frame()
for (animal_id in unique(filtered.all.data$animal)) {
  binned.data = filter(all.data.binned, animal == animal_id)
  res.kmeans.all = assign.clusters(binned.data)
  
  cor.ctrl = get.cor.data(binned.data, 'Ctrl', res.kmeans.all)
  cor.ctrl.df = melt(cor.ctrl) %>%
    dplyr::rename(cell.fst=Var1, cell.snd=Var2, cor=value)
  cor.ctrl.df$animal = rep(animal_id, nrow(cor.ctrl.df))
  cor.ctrl.df$exp = rep('Ctrl', nrow(cor.ctrl.df))
  
  cor.ach = get.cor.data(binned.data, 'ACh', res.kmeans.all)
  cor.ach.df = melt(cor.ach) %>%
    dplyr::rename(cell.fst=Var1, cell.snd=Var2, cor=value)
  cor.ach.df$animal = rep(animal_id, nrow(cor.ach.df))
  cor.ach.df$exp = rep('ACh', nrow(cor.ach.df))
  
  cor.atr = get.cor.data(binned.data, 'Atr', res.kmeans.all)
  cor.atr.df = melt(cor.atr) %>%
    dplyr::rename(cell.fst=Var1, cell.snd=Var2, cor=value)
  cor.atr.df$animal = rep(animal_id, nrow(cor.atr.df))
  cor.atr.df$exp = rep('Atr', nrow(cor.atr.df))
  
  cor.df = bind_rows(cor.df, cor.ctrl.df, cor.ach.df, cor.atr.df)
}
cor.df$animal = as.factor(cor.df$animal)
cor.df$exp = factor(cor.df$exp, levels=levels(filtered.all.data$exp))

cordist.df = left_join(dist.df, cor.df, by=c('animal', 'cell.fst', 'cell.snd')) %>%
  filter(cell.fst != cell.snd)

signif.exps = (filter(cors.pval.df, pval <= 0.05) %>% mutate(exp_name = paste(exp, animal)))$exp_name
```

Sample distances
```{r}
dist.binwidth = 50
binsample = 5
sampled.cordist.df = cordist.df %>%
  filter(paste(exp, animal) %in% signif.exps) %>%
  mutate(dist_bin = floor(dist/dist.binwidth)) %>%
  group_by(dist_bin, animal) %>%
  sample_n(binsample, replace=TRUE)

```


```{r}
sampled.cordist.df %>%
  ggplot() +
  geom_point(aes(x=dist * 1.1, y=cor), size=0.5, alpha=0.5, shape=16) +
  gtheme +
  facet_grid(. ~ exp) +
  labs(colour='') +
  theme(legend.position = 'none') +
  scale_x_continuous(breaks=c(0,200,400), limits=c(0, 400))+
  scale_y_continuous(breaks=c(0,1), limits=c(-0.6,1)) +
  xlab('Distance (um)') +
  ylab('Correlation')

ggsave(paste0(gen_imgs_dir, 'S2-corr_vs_distance.pdf'), 
       device=cairo_pdf,
       width=7, height=3.5, units='cm')
```

Plot activity raster for all networks
```{r}
all.clust.data = data.frame()
for (animal_id in levels(filtered.all.data$animal)) {
  # Skip the examplar network
  if (animal_id != 'Necab_M13') {
    data = filter(filtered.all.data, animal==animal_id)
    bin.width = data$frame.rate[1]
    cor.data = get.cor(data, cond='ACh')
    res.kmeans = eclust(cor.data, FUNcluster = "kmeans", hc_metric = "pearson", k=2, graph=FALSE)
    clust.data = add.cluster2(data, res.kmeans) %>%
      mutate(animal=animal_id)
    all.clust.data = bind_rows(all.clust.data, clust.data)
  }
}

all.activity.raster = plot.activity.raster(all.clust.data, bin.width) +
  facet_wrap(animal ~ exp, ncol=3, scales='free_y') +
  xlim(c(0,400)) +
  theme(strip.background = element_blank(),
        strip.text = element_blank(),
        axis.line.y = element_blank(),
        legend.position = 'right',
        legend.text = element_text(size = 8),
        legend.key.height = unit(2, 'mm'),
        legend.box.margin = margin(0,0,0,0),
        legend.box.spacing = unit(0, 'mm')) +
  labs(fill='z-scored\nΔF/F') 

ggsave(paste0(gen_imgs_dir, 'S5-1-pop_activity.png'), 
       all.activity.raster,
       dpi=300,
       width=width_2col, height=27, units='cm')
```

